#!/bin/bash
# Test runner script for wxlistener

set -e

echo "ğŸ§ª Running wxlistener test suite..."
echo ""

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print section headers
print_section() {
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BLUE}$1${NC}"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
}

# Check formatting
print_section "ğŸ“ Checking code formatting"
cargo fmt -- --check
echo -e "${GREEN}âœ“ Code formatting OK${NC}"
echo ""

# Run clippy
print_section "ğŸ“ Running clippy lints"
cargo clippy -- -D warnings
echo -e "${GREEN}âœ“ Clippy checks passed${NC}"
echo ""

# Run unit tests
print_section "ğŸ”¬ Running unit tests"
cargo test --lib
echo -e "${GREEN}âœ“ Unit tests passed${NC}"
echo ""

# Run integration tests
print_section "ğŸ”— Running integration tests"
cargo test --test integration_test
echo -e "${GREEN}âœ“ Integration tests passed${NC}"
echo ""

# Run all tests
print_section "ğŸ§ª Running all tests"
cargo test --all
echo -e "${GREEN}âœ“ All tests passed${NC}"
echo ""

# Build release
print_section "ğŸ—ï¸  Building release binary"
cargo build --release
echo -e "${GREEN}âœ“ Release build successful${NC}"
echo ""

# Copy example config to release directory
echo "ğŸ“„ Copying example config file..."
cp wxlistener.example.toml ./target/release/wxlistener.example.toml
echo -e "${GREEN}âœ“ Example config copied to release directory${NC}"
echo ""

# Summary
print_section "âœ… All checks passed!"
echo -e "${GREEN}Your code is ready to ship! ğŸš€${NC}"
echo ""
echo "Binary location: ./target/release/wxlistener"
echo "Binary size: $(du -h ./target/release/wxlistener | cut -f1)"
echo "Example config: ./target/release/wxlistener.example.toml"
echo ""
