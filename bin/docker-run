#!/bin/bash
# Run wxlistener in Docker

set -e

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo ""
echo -e "${BLUE}ðŸ³ Running wxlistener in Docker${NC}"
echo ""

# Check if config file exists
if [ ! -f "wxlistener.toml" ]; then
    echo -e "${YELLOW}âš  Config file not found. Creating example...${NC}"
    cat > wxlistener.toml << 'EOF'
# WXListener Configuration File
ip = "10.31.100.42"
port = 45000
EOF
    echo -e "${GREEN}âœ“ Created wxlistener.toml${NC}"
    echo -e "${YELLOW}  Please update with your device's IP address${NC}"
    echo ""
fi

# Parse arguments
MODE="${1:-single}"

case "$MODE" in
    single)
        echo -e "${BLUE}Running single read...${NC}"
        docker run --rm \
            --network host \
            -v "$(pwd)/wxlistener.toml:/home/wxlistener/wxlistener.toml:ro" \
            wxlistener:latest \
            --config wxlistener.toml
        ;;
    
    continuous)
        INTERVAL="${2:-60}"
        echo -e "${BLUE}Running continuous mode (every $INTERVAL seconds)...${NC}"
        echo -e "${YELLOW}Press Ctrl+C to stop${NC}"
        echo ""
        docker run --rm \
            --network host \
            -v "$(pwd)/wxlistener.toml:/home/wxlistener/wxlistener.toml:ro" \
            wxlistener:latest \
            --config wxlistener.toml \
            --continuous "$INTERVAL"
        ;;
    
    json)
        echo -e "${BLUE}Running with JSON output...${NC}"
        docker run --rm \
            --network host \
            -v "$(pwd)/wxlistener.toml:/home/wxlistener/wxlistener.toml:ro" \
            wxlistener:latest \
            --config wxlistener.toml \
            --format json
        ;;
    
    compose)
        echo -e "${BLUE}Starting with docker-compose...${NC}"
        docker-compose up
        ;;
    
    compose-continuous)
        echo -e "${BLUE}Starting continuous mode with docker-compose...${NC}"
        docker-compose --profile continuous up wxlistener-continuous
        ;;
    
    *)
        echo "Usage: $0 [single|continuous|json|compose|compose-continuous] [interval]"
        echo ""
        echo "Examples:"
        echo "  $0 single              # Single read"
        echo "  $0 continuous 30       # Poll every 30 seconds"
        echo "  $0 json                # JSON output"
        echo "  $0 compose             # Use docker-compose"
        echo "  $0 compose-continuous  # Continuous with docker-compose"
        exit 1
        ;;
esac

echo ""
