#!/bin/bash
# Run wxlistener in Docker

set -e

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo ""
echo -e "${BLUE}üê≥ Running wxlistener in Docker${NC}"
echo ""

# Check if .env file exists, if not create from example
if [ ! -f ".env" ] && [ -f ".env.example" ]; then
    echo -e "${YELLOW}‚ö† .env file not found. Creating from .env.example...${NC}"
    cp .env.example .env
    echo -e "${GREEN}‚úì Created .env${NC}"
    echo -e "${YELLOW}  Please update .env with your device's IP address${NC}"
    echo ""
fi

# Load environment variables if .env exists
if [ -f ".env" ]; then
    export $(cat .env | grep -v '^#' | xargs)
fi

# Use environment variable or default
DEVICE_IP="${WXLISTENER_IP:-10.31.100.42}"
DEVICE_PORT="${WXLISTENER_PORT:-45000}"
POLL_INTERVAL="${WXLISTENER_INTERVAL:-60}"
OUTPUT_FORMAT="${WXLISTENER_FORMAT:-text}"

# Parse arguments
MODE="${1:-single}"

case "$MODE" in
    default|continuous)
        INTERVAL="${2:-$POLL_INTERVAL}"
        echo -e "${BLUE}Running continuous mode (every $INTERVAL seconds)...${NC}"
        echo -e "${BLUE}Device: $DEVICE_IP:$DEVICE_PORT${NC}"
        echo -e "${YELLOW}Press Ctrl+C to stop${NC}"
        echo ""
        docker run --rm \
            --network host \
            -e WXLISTENER_IP="$DEVICE_IP" \
            -e WXLISTENER_PORT="$DEVICE_PORT" \
            -e WXLISTENER_INTERVAL="$INTERVAL" \
            -e WXLISTENER_FORMAT="$OUTPUT_FORMAT" \
            wxlistener:latest
        ;;
    
    single)
        echo -e "${BLUE}Running single read...${NC}"
        echo -e "${BLUE}Device: $DEVICE_IP:$DEVICE_PORT${NC}"
        docker run --rm \
            --network host \
            -e WXLISTENER_IP="$DEVICE_IP" \
            -e WXLISTENER_PORT="$DEVICE_PORT" \
            wxlistener:latest \
            sh -c "wxlistener --ip \$WXLISTENER_IP --port \$WXLISTENER_PORT"
        ;;
    
    json)
        echo -e "${BLUE}Running with JSON output...${NC}"
        echo -e "${BLUE}Device: $DEVICE_IP:$DEVICE_PORT${NC}"
        docker run --rm \
            --network host \
            -e WXLISTENER_IP="$DEVICE_IP" \
            -e WXLISTENER_PORT="$DEVICE_PORT" \
            -e WXLISTENER_FORMAT="json" \
            wxlistener:latest
        ;;
    
    compose)
        echo -e "${BLUE}Starting with docker-compose...${NC}"
        docker-compose up
        ;;
    
    *)
        echo "Usage: $0 [default|single|json|compose] [interval]"
        echo ""
        echo "Examples:"
        echo "  $0                     # Default: continuous mode"
        echo "  $0 default 30          # Continuous, poll every 30 seconds"
        echo "  $0 single              # Single read"
        echo "  $0 json                # Continuous with JSON output"
        echo "  $0 compose             # Use docker-compose"
        echo ""
        echo "Configuration:"
        echo "  Set WXLISTENER_IP in .env file or environment"
        exit 1
        ;;
esac

echo ""
